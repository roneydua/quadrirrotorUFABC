<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<doxygen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="compound.xsd" version="1.9.1" xml:lang="pt-BR">
  <compounddef id="EKF_8cpp" kind="file" language="C++">
    <compoundname>EKF.cpp</compoundname>
    <includes refid="EKF_8h" local="yes">EKF.h</includes>
    <incdepgraph>
      <node id="2">
        <label>EKF.h</label>
        <link refid="EKF_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="5" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="7" relation="include">
        </childnode>
      </node>
      <node id="3">
        <label>eigen3/Eigen/Dense</label>
      </node>
      <node id="4">
        <label>../../include/READWRITEEIGEN/readWriteEigen.h</label>
      </node>
      <node id="5">
        <label>../AQUA/AQUA.h</label>
        <link refid="AQUA_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
      </node>
      <node id="1">
        <label>lib/EKF/EKF.cpp</label>
        <link refid="EKF_8cpp"/>
        <childnode refid="2" relation="include">
        </childnode>
      </node>
      <node id="7">
        <label>iostream</label>
      </node>
      <node id="6">
        <label>../GRUPO_QUAT/GRUPO_QUAT.h</label>
        <link refid="GRUPO__QUAT_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="7" relation="include">
        </childnode>
      </node>
    </incdepgraph>
    <innernamespace refid="namespaceekf">ekf</innernamespace>
    <briefdescription>
<para>Classe que implementa o filtro de Kalman estendido. </para>
    </briefdescription>
    <detaileddescription>
<para><simplesect kind="author"><para>: Roney Silva (roney) </para>
</simplesect>
<simplesect kind="date"><para>: 16-Aug-2021 Email: <ulink url="mailto:roneyddasilva@gmail.com">roneyddasilva@gmail.com</ulink> Project: quadrirrotorUFABC</para>
</simplesect>
Last modified by: roney Last modified time: 01-Sep-2021 </para>
    </detaileddescription>
    <programlisting>
<codeline lineno="1"><highlight class="normal"></highlight></codeline>
<codeline lineno="12"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;<ref refid="EKF_8h" kindref="compound">EKF.h</ref>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="13"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>__XTENSA__</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="14"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;<ref refid="GPS_8h" kindref="compound">GPS.h</ref>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="15"><highlight class="normal"></highlight></codeline>
<codeline lineno="16"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;<ref refid="IMU_8h" kindref="compound">IMU.h</ref>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="17"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;<ref refid="TIME_8h" kindref="compound">TIME.h</ref>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="18"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;Arduino.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="19"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="20"><highlight class="normal"></highlight><highlight class="comment">//<sp/>#include<sp/>&quot;../AQUA/AQUA.h&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="21"><highlight class="normal"></highlight><highlight class="comment">//<sp/>#include<sp/>&quot;../GRUPO_QUAT/GRUPO_QUAT.h&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="22"><highlight class="normal"></highlight></codeline>
<codeline lineno="23" refid="namespaceekf" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">namespace<sp/></highlight><highlight class="normal"><ref refid="namespaceekf" kindref="compound">ekf</ref><sp/>{</highlight></codeline>
<codeline lineno="27"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>__XTENSA__</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="28"><highlight class="normal"><ref refid="classIMU" kindref="compound">IMU</ref><sp/>imu(Wire,<sp/>0x68);</highlight></codeline>
<codeline lineno="29"><highlight class="normal"><ref refid="classTIME" kindref="compound">TIME</ref><sp/>timeClass;</highlight></codeline>
<codeline lineno="30"><highlight class="normal"><ref refid="classTIME" kindref="compound">TIME</ref><sp/>timeClassLoop;</highlight></codeline>
<codeline lineno="31"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="32" refid="namespaceekf_1a224c884f9fa345bfef8f140150919b3e" refkind="member"><highlight class="normal"><ref refid="classAQUA" kindref="compound">AQUA</ref><sp/><ref refid="namespaceekf_1a224c884f9fa345bfef8f140150919b3e" kindref="member">aqua</ref>;</highlight></codeline>
<codeline lineno="33" refid="classekf_1_1EKF_1aea7bda69ce19f724930eb8c691272508" refkind="member"><highlight class="normal"><ref refid="classekf_1_1EKF_1aea7bda69ce19f724930eb8c691272508" kindref="member">EKF::EKF</ref>()<sp/>{}</highlight></codeline>
<codeline lineno="40" refid="classekf_1_1EKF_1a4a6998123529ab0d0844ad21419fc895" refkind="member"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="classekf_1_1EKF_1a4a6998123529ab0d0844ad21419fc895" kindref="member">EKF::begin</ref>(</highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>_dt)<sp/>{</highlight></codeline>
<codeline lineno="41"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>__XTENSA__</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="42"><highlight class="normal"><sp/><sp/>printf(</highlight><highlight class="stringliteral">&quot;Nucleo<sp/>do<sp/>Filtro:<sp/>%d\n&quot;</highlight><highlight class="normal">,<sp/>xPortGetCoreID());</highlight></codeline>
<codeline lineno="43"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="44"><highlight class="normal"><sp/><sp/><ref refid="classekf_1_1EKF_1a7638c17e8939f2c45f1bbda2260621cc" kindref="member">status</ref><sp/>=<sp/><ref refid="namespaceekf_1a3d0224f90468a854a2440df8b4f78869a0c401f1c67fce956b571e01d0f1a67d8" kindref="member">BEGIN</ref>;</highlight></codeline>
<codeline lineno="45"><highlight class="normal"><sp/><sp/>this-&gt;<ref refid="classekf_1_1EKF_1aee84ca91742c11dd89683930a58d59e3" kindref="member">dt</ref><sp/>=<sp/>_dt;</highlight></codeline>
<codeline lineno="46"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>__XTENSA__</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="47"><highlight class="normal"><sp/><sp/><ref refid="GPS_8h_1a35c55bcf9a6f5a52f34cb1ab02c91479" kindref="member">gpsSetup</ref>();</highlight></codeline>
<codeline lineno="48"><highlight class="normal"></highlight></codeline>
<codeline lineno="49"><highlight class="normal"><sp/><sp/>timeClass.<ref refid="classTIME_1a8cd98765b05a23aa7afe8fa5234b9695" kindref="member">begin</ref>();</highlight></codeline>
<codeline lineno="50"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>timeClassLoop.begin();</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="51"><highlight class="normal"></highlight></codeline>
<codeline lineno="52"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="53"><highlight class="normal"></highlight></codeline>
<codeline lineno="54"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>Instancia<sp/>o<sp/>vetor<sp/>de<sp/>medidas<sp/>na<sp/>biblioteca<sp/>da<sp/>IMU.</highlight></codeline>
<codeline lineno="57"><highlight class="comment"></highlight><highlight class="preprocessor">#ifdef<sp/>__XTENSA__</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="58"><highlight class="normal"><sp/><sp/>imu.<ref refid="classIMU_1ae0d964d2f8ec122be068c41b84bc18a8" kindref="member">begin</ref>(<ref refid="classekf_1_1EKF_1a30d3adf68cc6ee599fec8fa45a697bbb" kindref="member">accel</ref>,<sp/><ref refid="classekf_1_1EKF_1af990ea0dbcd3f286f04584ab663d08e6" kindref="member">gyro</ref>,<sp/><ref refid="classekf_1_1EKF_1a3f84435c646a27ad0f922e5205c13eb3" kindref="member">mag</ref>);</highlight></codeline>
<codeline lineno="59"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>referencia<sp/>o<sp/>bias<sp/>da<sp/>classe<sp/>IMU.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="60"><highlight class="normal"><sp/><sp/><ref refid="classekf_1_1EKF_1a50b05a6fb2c055d9c37e44138a05b08e" kindref="member">biasGyro</ref><sp/>=<sp/>&amp;imu.<ref refid="classIMU_1a9d22cd7cb7bb93f2e04aa713aed73532" kindref="member">_biasGyro</ref>;</highlight></codeline>
<codeline lineno="61"><highlight class="normal"><sp/><sp/><ref refid="classekf_1_1EKF_1a1ac62c76df373623c4cfa0b2b37564db" kindref="member">biasAccel</ref><sp/>=<sp/>&amp;imu.<ref refid="classIMU_1a9a145f45e2e08cae0f363747c5603bd1" kindref="member">_biasAccel</ref>;</highlight></codeline>
<codeline lineno="62"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="63"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>Atualiza<sp/>valor<sp/>do<sp/>bias<sp/>do<sp/>giroscópio<sp/>com<sp/>uma<sp/>média<sp/>de<sp/>amostras</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="64"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>valores<sp/>constantes<sp/>das<sp/>matriz<sp/>F</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="65"><highlight class="normal"><sp/><sp/><ref refid="classekf_1_1EKF_1aae2ea65c4362a5f798db195112fb094a" kindref="member">mF</ref>.block&lt;3,<sp/>3&gt;(0,<sp/>3)<sp/>=<sp/>-0.5f<sp/>*<sp/>Eigen::Matrix3f::Identity();</highlight></codeline>
<codeline lineno="66"><highlight class="normal"><sp/><sp/><ref refid="classekf_1_1EKF_1aae2ea65c4362a5f798db195112fb094a" kindref="member">mF</ref>.block&lt;3,<sp/>3&gt;(12,<sp/>6)<sp/>=<sp/>Eigen::Matrix3f::Identity();</highlight></codeline>
<codeline lineno="67"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>Valores<sp/>constantes<sp/>da<sp/>matriz<sp/>G</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="68"><highlight class="normal"><sp/><sp/><ref refid="classekf_1_1EKF_1a110201c01d9ce3c63a1de068e87be75d" kindref="member">G</ref>.topLeftCorner(3,<sp/>3)<sp/>=<sp/>-0.5f<sp/>*<sp/>Eigen::Matrix3f::Identity();</highlight></codeline>
<codeline lineno="69"><highlight class="normal"><sp/><sp/><ref refid="classekf_1_1EKF_1a110201c01d9ce3c63a1de068e87be75d" kindref="member">G</ref>.block&lt;3,<sp/>3&gt;(3,<sp/>3)<sp/>=<sp/>Eigen::Matrix3f::Identity();</highlight></codeline>
<codeline lineno="70"><highlight class="normal"><sp/><sp/><ref refid="classekf_1_1EKF_1a110201c01d9ce3c63a1de068e87be75d" kindref="member">G</ref>.block(6,<sp/>6,<sp/>3,<sp/>3)<sp/>=<sp/>-Eigen::Matrix3f::Identity();</highlight></codeline>
<codeline lineno="71"><highlight class="normal"><sp/><sp/><ref refid="classekf_1_1EKF_1a110201c01d9ce3c63a1de068e87be75d" kindref="member">G</ref>.block&lt;3,<sp/>3&gt;(9,<sp/>9)<sp/>=<sp/>Eigen::Matrix3f::Identity();</highlight></codeline>
<codeline lineno="72"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>matrix<sp/>de<sp/>covariâncias<sp/>do<sp/>processo<sp/>continuo</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="73"><highlight class="normal"><sp/><sp/>Eigen::MatrixXf<sp/>Q<sp/>=<sp/>Eigen::MatrixXf::Identity(12,<sp/>12);</highlight></codeline>
<codeline lineno="74"><highlight class="normal"><sp/><sp/>Eigen::Matrix3f<sp/>_I<sp/>=<sp/>Eigen::Matrix3f::Identity();</highlight></codeline>
<codeline lineno="75"><highlight class="normal"><sp/><sp/>Q.block&lt;3,<sp/>3&gt;(0,<sp/>0)<sp/>=<sp/>_I<sp/>*<sp/>_dt<sp/>*<sp/>_dt<sp/>*<sp/><ref refid="classekf_1_1EKF_1a5d610d6e3174f24f9be38e7da3d44bc0" kindref="member">sigma_giro_squared</ref>;</highlight></codeline>
<codeline lineno="76"><highlight class="normal"><sp/><sp/>Q.block&lt;3,<sp/>3&gt;(3,<sp/>3)<sp/>=<sp/>_I<sp/>*<sp/>_dt<sp/>*<sp/><ref refid="classekf_1_1EKF_1a883bdaa556cb199f75216286386523c1" kindref="member">sigma_bias_giro_squared</ref>;</highlight></codeline>
<codeline lineno="77"><highlight class="normal"><sp/><sp/>Q.block&lt;3,<sp/>3&gt;(6,<sp/>6)<sp/>=<sp/>_I<sp/>*<sp/>_dt<sp/>*<sp/>_dt<sp/>*<sp/><ref refid="classekf_1_1EKF_1a39f7ad374d1ef4a03fdb8cd8bba59846" kindref="member">sigma_accel_squared</ref>;</highlight></codeline>
<codeline lineno="78"><highlight class="normal"><sp/><sp/>Q.block&lt;3,<sp/>3&gt;(9,<sp/>9)<sp/>=<sp/>_I<sp/>*<sp/>_dt<sp/>*<sp/><ref refid="classekf_1_1EKF_1a4a3b3eb81885f23ec476cfbdeae7666f" kindref="member">sigma_bias_accel_squared</ref>;</highlight></codeline>
<codeline lineno="79"><highlight class="normal"><sp/><sp/><ref refid="classekf_1_1EKF_1a0e5efc2e95419aaea976414f246a378a" kindref="member">Q_k</ref><sp/>=<sp/><ref refid="classekf_1_1EKF_1a110201c01d9ce3c63a1de068e87be75d" kindref="member">G</ref><sp/>*<sp/>Q<sp/>*<sp/><ref refid="classekf_1_1EKF_1a110201c01d9ce3c63a1de068e87be75d" kindref="member">G</ref>.transpose();</highlight></codeline>
<codeline lineno="80"><highlight class="normal"><sp/><sp/><ref refid="classekf_1_1EKF_1ad55e1ba3736ea08721dec76f03dd9715" kindref="member">R</ref>.block&lt;4,<sp/>4&gt;(0,<sp/>0)<sp/>=<sp/>Eigen::Matrix4f::Identity()<sp/>*<sp/><ref refid="classekf_1_1EKF_1a2ea4005a93d82e6b448fdb4fd4e36dd1" kindref="member">sigma_aqua_squared</ref>;</highlight></codeline>
<codeline lineno="81"><highlight class="normal"></highlight></codeline>
<codeline lineno="82"><highlight class="normal"></highlight><highlight class="preprocessor">#ifndef<sp/>__XTENSA__</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="83"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>Q_k<sp/>=<sp/>csvLeia&lt;Eigen::MatrixXf&gt;(&quot;Q&quot;);</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="84"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>R<sp/>=<sp/>csvLeia&lt;Eigen::MatrixXf&gt;(&quot;R&quot;);</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="85"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="86"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>condições<sp/>iniciais<sp/>da<sp/>posicao</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="87"><highlight class="normal"><sp/><sp/><ref refid="namespaceekf_1a224c884f9fa345bfef8f140150919b3e" kindref="member">aqua</ref>.<ref refid="classAQUA_1a8809dddd7e4f74f3eb7bd1fc4a604ae4" kindref="member">begin</ref>(<ref refid="classekf_1_1EKF_1a803ccbdd54bfbd96cccf57afa60578a9" kindref="member">qObs</ref>,<sp/><ref refid="classekf_1_1EKF_1a30d3adf68cc6ee599fec8fa45a697bbb" kindref="member">accel</ref>,<sp/><ref refid="classekf_1_1EKF_1a3f84435c646a27ad0f922e5205c13eb3" kindref="member">mag</ref>);</highlight></codeline>
<codeline lineno="88"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>__XTENSA__</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="89"><highlight class="normal"><sp/><sp/>updateBaseRef();</highlight></codeline>
<codeline lineno="90"><highlight class="normal"><sp/><sp/>imu.<ref refid="classIMU_1ac574728dbbc752155239a35c8bbd6e79" kindref="member">readSensor</ref>();</highlight></codeline>
<codeline lineno="91"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="92"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>valor<sp/>inicial<sp/>a<sp/>partir<sp/>da<sp/>medida</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="93"><highlight class="normal"><sp/><sp/><ref refid="namespaceekf_1a224c884f9fa345bfef8f140150919b3e" kindref="member">aqua</ref>.<ref refid="classAQUA_1ae3ddff89a969a0d2a3d3c675ed5b8065" kindref="member">computeAQUAQuaternion</ref>();</highlight></codeline>
<codeline lineno="94"><highlight class="normal"><sp/><sp/><ref refid="classekf_1_1EKF_1aa38bc83dfb656519cfcda0c0a589ef16" kindref="member">q</ref><sp/>=<sp/><ref refid="classekf_1_1EKF_1a803ccbdd54bfbd96cccf57afa60578a9" kindref="member">qObs</ref>;</highlight></codeline>
<codeline lineno="95"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>aqua.qAlignment<sp/>=<sp/>qObs;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="96"><highlight class="normal"><sp/><sp/><ref refid="classekf_1_1EKF_1a7638c17e8939f2c45f1bbda2260621cc" kindref="member">status</ref><sp/>=<sp/><ref refid="namespaceekf_1a3d0224f90468a854a2440df8b4f78869a638dfa2cadaad15202600951a2e30d4f" kindref="member">READY</ref>;</highlight></codeline>
<codeline lineno="97"><highlight class="normal">}</highlight></codeline>
<codeline lineno="101" refid="classekf_1_1EKF_1a651814ff64d234394572e2e7c5703a43" refkind="member"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="classekf_1_1EKF_1a651814ff64d234394572e2e7c5703a43" kindref="member">EKF::loopEKF</ref>()<sp/>{</highlight></codeline>
<codeline lineno="102"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>le<sp/>os<sp/>sensores</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="103"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>timeClassLoop.computeElapsedTime();</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="104"><highlight class="normal"><sp/><sp/>updateOfMeasurements();</highlight></codeline>
<codeline lineno="105"><highlight class="normal"><sp/><sp/>predictionStage();</highlight></codeline>
<codeline lineno="106"><highlight class="normal"><sp/><sp/>updateStage();</highlight></codeline>
<codeline lineno="107"><highlight class="normal"><sp/><sp/>updateStates();</highlight></codeline>
<codeline lineno="108"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>dtLoop<sp/>=<sp/>timeClassLoop.computeElapsedTime();</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="109"><highlight class="normal">}</highlight></codeline>
<codeline lineno="110"><highlight class="normal"></highlight></codeline>
<codeline lineno="114"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>EKF::predictionStage()<sp/>{</highlight></codeline>
<codeline lineno="115"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>Integracao<sp/>dos<sp/>estados</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="116"><highlight class="normal"><sp/><sp/>integrationOfStates();</highlight></codeline>
<codeline lineno="117"><highlight class="normal"><sp/><sp/>updateF();</highlight></codeline>
<codeline lineno="118"><highlight class="normal"><sp/><sp/>updateFi();</highlight></codeline>
<codeline lineno="119"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>atualiza<sp/>a<sp/>matriz<sp/>de<sp/>covariâncias</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="120"><highlight class="normal"><sp/><sp/><ref refid="classekf_1_1EKF_1aec9a3a7de4a079cd1dd1baae26a7a6fc" kindref="member">P</ref><sp/>=<sp/><ref refid="classekf_1_1EKF_1a78dd6de9d37bc221394db5e9cca2086f" kindref="member">fi</ref><sp/>*<sp/><ref refid="classekf_1_1EKF_1aec9a3a7de4a079cd1dd1baae26a7a6fc" kindref="member">P</ref><sp/>*<sp/><ref refid="classekf_1_1EKF_1a78dd6de9d37bc221394db5e9cca2086f" kindref="member">fi</ref>.transpose()<sp/>+<sp/><ref refid="classekf_1_1EKF_1a0e5efc2e95419aaea976414f246a378a" kindref="member">Q_k</ref>;</highlight></codeline>
<codeline lineno="121"><highlight class="normal">}</highlight></codeline>
<codeline lineno="129"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>EKF::updateOfMeasurements()<sp/>{</highlight></codeline>
<codeline lineno="130"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>__XTENSA__</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="131"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>Faz<sp/>a<sp/>leitura<sp/>dos<sp/>sensores<sp/>da<sp/>MARG<sp/>atualizando<sp/>os<sp/>vetores<sp/>#accel,<sp/>#gyro<sp/>e</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="132"><highlight class="normal"><sp/><sp/>imu.<ref refid="classIMU_1ac574728dbbc752155239a35c8bbd6e79" kindref="member">readSensor</ref>();</highlight></codeline>
<codeline lineno="133"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>tempo<sp/>decorrido<sp/>entre<sp/>medidas<sp/>a<sp/>medida<sp/>anterior<sp/>e<sp/>a<sp/>atual.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="134"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>dt<sp/>=<sp/>timeClass.computeElapsedTime();</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="135"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>Etapa<sp/>de<sp/>predição.<sp/>Verifica<sp/>se<sp/>há<sp/>medidas<sp/>novas<sp/>a<sp/>partir<sp/>do<sp/>GPS.<sp/>A<sp/>função</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="136"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>processoGPS()<sp/>retorna<sp/>a<sp/>MT_NONE,<sp/>MT_NAV_POSLLH,<sp/>MT_NAV_VELNED<sp/>ou<sp/>MT_NAV_PVT</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="137"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>dependendo<sp/>da<sp/>configuração<sp/>no<sp/>cabeçalho<sp/>GPS.h.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="138"><highlight class="normal"><sp/><sp/><ref refid="classekf_1_1EKF_1a8d016a5adf9aa5f33a8c9e1f7dd73592" kindref="member">messageGPS</ref><sp/>=<sp/><ref refid="GPS_8h_1ad604e63cc857e5663dfba96c37c66bc7" kindref="member">processGPS</ref>();</highlight></codeline>
<codeline lineno="143"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>p<sp/>e<sp/>n<sp/>corresponde<sp/>aos<sp/>numeros<sp/>de<sp/>medidas<sp/>e<sp/>estados.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="144"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="classekf_1_1EKF_1a8d016a5adf9aa5f33a8c9e1f7dd73592" kindref="member">messageGPS</ref><sp/>==<sp/><ref refid="GPS_8h_1a9730e8d0bbbe3f1515ed1d0b2acda1e1ad2e3f1bdeae0fa235b7dfe6656c46f14" kindref="member">MT_NONE</ref>)<sp/>{</highlight></codeline>
<codeline lineno="145"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>não<sp/>ha<sp/>observações<sp/>de<sp/>posição<sp/>ou<sp/>velocidade</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="146"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="classekf_1_1EKF_1af019016496e0328e5d9ea3cb6462e52c" kindref="member">p</ref><sp/>=<sp/><ref refid="classekf_1_1EKF_1ad3a628fffe1f640b4968b8f6f8ef3b14" kindref="member">pAtitude</ref>;</highlight></codeline>
<codeline lineno="147"><highlight class="normal"><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="classekf_1_1EKF_1a8d016a5adf9aa5f33a8c9e1f7dd73592" kindref="member">messageGPS</ref><sp/>==<sp/><ref refid="GPS_8h_1a9730e8d0bbbe3f1515ed1d0b2acda1e1ae2379a504fb11d8e00e11bd567a3b819" kindref="member">MT_NAV_POSECEF</ref>)<sp/>{</highlight></codeline>
<codeline lineno="148"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>há<sp/>observação<sp/>de<sp/>posicao</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="149"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="classekf_1_1EKF_1af019016496e0328e5d9ea3cb6462e52c" kindref="member">p</ref><sp/>=<sp/><ref refid="classekf_1_1EKF_1ac02e28e5bd4b3e90d3ccb3dd1127e7b2" kindref="member">pFull</ref>;</highlight></codeline>
<codeline lineno="150"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Atualiza<sp/>o<sp/>erro<sp/>de<sp/>medida<sp/>na<sp/>velocidade<sp/>linear</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="151"><highlight class="normal"><sp/><sp/><sp/><sp/>updateNedPos();</highlight></codeline>
<codeline lineno="152"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Atualiza<sp/>matriz<sp/>covariancia<sp/>da<sp/>matriz<sp/>de<sp/>observação<sp/>da<sp/>posição</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="153"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="classekf_1_1EKF_1ad55e1ba3736ea08721dec76f03dd9715" kindref="member">R</ref>.block&lt;3,<sp/>3&gt;(4,<sp/>4)<sp/>=<sp/><ref refid="classekf_1_1EKF_1a02c9e5ede2b47a773c2f59fb9cf9169c" kindref="member">sigma_pos_squared</ref><sp/>*<sp/>Eigen::Matrix3f::Identity();</highlight></codeline>
<codeline lineno="154"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="classekf_1_1EKF_1ae4be03b8440c0f1185141ecc359534df" kindref="member">deltaYObs</ref>.tail(3)<sp/>=<sp/><ref refid="classekf_1_1EKF_1a649f7d975dc55413be50d8f1e6bc2559" kindref="member">rNEDgps</ref><sp/>-<sp/><ref refid="classekf_1_1EKF_1a833f15f8790f86633d8b02eb2fe3616e" kindref="member">rNED</ref>;</highlight></codeline>
<codeline lineno="155"><highlight class="normal"><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="classekf_1_1EKF_1a8d016a5adf9aa5f33a8c9e1f7dd73592" kindref="member">messageGPS</ref><sp/>==<sp/><ref refid="GPS_8h_1a9730e8d0bbbe3f1515ed1d0b2acda1e1a87ee2b7c21367a2caa62b0a01491ea23" kindref="member">MT_NAV_PVT</ref>)<sp/>{</highlight></codeline>
<codeline lineno="156"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="classekf_1_1EKF_1af019016496e0328e5d9ea3cb6462e52c" kindref="member">p</ref><sp/>=<sp/><ref refid="classekf_1_1EKF_1ac02e28e5bd4b3e90d3ccb3dd1127e7b2" kindref="member">pFull</ref>;</highlight></codeline>
<codeline lineno="157"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>há<sp/>observações<sp/>de<sp/>velocidade</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="158"><highlight class="normal"><sp/><sp/><sp/><sp/>updateNedVel();</highlight></codeline>
<codeline lineno="159"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Atualiza<sp/>matriz<sp/>covariancia<sp/>da<sp/>matriz<sp/>de<sp/>observação<sp/>da<sp/>velocidade</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="160"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="classekf_1_1EKF_1ad55e1ba3736ea08721dec76f03dd9715" kindref="member">R</ref>.block&lt;3,<sp/>3&gt;(4,<sp/>4)<sp/>=<sp/><ref refid="classekf_1_1EKF_1af1d82a9698078624dd2e65c808126510" kindref="member">sigma_vel_squared</ref><sp/>*<sp/>Eigen::Matrix3f::Identity();</highlight></codeline>
<codeline lineno="161"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="classekf_1_1EKF_1ae4be03b8440c0f1185141ecc359534df" kindref="member">deltaYObs</ref>.tail(3)<sp/>=<sp/><ref refid="classekf_1_1EKF_1ad27f8aac391293234c9e21c02b944cc4" kindref="member">drNEDgps</ref><sp/>-<sp/><ref refid="classekf_1_1EKF_1a93f50b0576c3243487442a9f0934e038" kindref="member">drNED</ref>;</highlight></codeline>
<codeline lineno="162"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="163"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="164"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>computa<sp/>o<sp/>quaternion<sp/>de<sp/>observação<sp/>com<sp/>o<sp/>algoritmo<sp/>#AQUA.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="165"><highlight class="normal"><sp/><sp/><ref refid="namespaceekf_1a224c884f9fa345bfef8f140150919b3e" kindref="member">aqua</ref>.<ref refid="classAQUA_1ae3ddff89a969a0d2a3d3c675ed5b8065" kindref="member">computeAQUAQuaternion</ref>();</highlight></codeline>
<codeline lineno="166"><highlight class="normal">}</highlight></codeline>
<codeline lineno="170"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>EKF::updateF()<sp/>{</highlight></codeline>
<codeline lineno="172"><highlight class="normal"><sp/><sp/><ref refid="classekf_1_1EKF_1aae2ea65c4362a5f798db195112fb094a" kindref="member">mF</ref>.topLeftCorner(3,<sp/>3)<sp/>=<sp/>-<ref refid="namespaceekf_1af3f0a631343e55ec8b42f3fbea182461" kindref="member">skew</ref>(<ref refid="classekf_1_1EKF_1af990ea0dbcd3f286f04584ab663d08e6" kindref="member">gyro</ref>);</highlight></codeline>
<codeline lineno="173"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>TEST:<sp/>Matrix<sp/>mF<sp/>atualizada<sp/>em<sp/>todos<sp/>os<sp/>loops</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="174"><highlight class="normal"><sp/><sp/><ref refid="classekf_1_1EKF_1aae2ea65c4362a5f798db195112fb094a" kindref="member">mF</ref>.block&lt;3,<sp/>3&gt;(6,<sp/>0)<sp/>=<sp/>-2.0<sp/>*<sp/><ref refid="classekf_1_1EKF_1a2f7f579eb38461f7396cca2a9a846bbb" kindref="member">mcd</ref><sp/>*<sp/><ref refid="namespaceekf_1af3f0a631343e55ec8b42f3fbea182461" kindref="member">skew</ref>(<ref refid="classekf_1_1EKF_1a30d3adf68cc6ee599fec8fa45a697bbb" kindref="member">accel</ref>);</highlight></codeline>
<codeline lineno="175"><highlight class="normal"><sp/><sp/><ref refid="classekf_1_1EKF_1aae2ea65c4362a5f798db195112fb094a" kindref="member">mF</ref>.block&lt;3,<sp/>3&gt;(6,<sp/>9)<sp/>=<sp/>-<ref refid="classekf_1_1EKF_1a2f7f579eb38461f7396cca2a9a846bbb" kindref="member">mcd</ref>;</highlight></codeline>
<codeline lineno="176"><highlight class="normal">}</highlight></codeline>
<codeline lineno="182"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>EKF::updateFi()<sp/>{</highlight></codeline>
<codeline lineno="183"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>fi<sp/>=<sp/>I+dt<sp/>*<sp/>F</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="184"><highlight class="normal"><sp/><sp/><ref refid="classekf_1_1EKF_1a78dd6de9d37bc221394db5e9cca2086f" kindref="member">fi</ref><sp/>=<sp/>Eigen::MatrixXf::Identity(<ref refid="classekf_1_1EKF_1abd8ccdb99191c1f3a7a5c03421f93d87" kindref="member">nFull</ref>,<sp/><ref refid="classekf_1_1EKF_1abd8ccdb99191c1f3a7a5c03421f93d87" kindref="member">nFull</ref>)<sp/>+<sp/>(<ref refid="classekf_1_1EKF_1aae2ea65c4362a5f798db195112fb094a" kindref="member">mF</ref><sp/>*<sp/>(0.5f<sp/>*<sp/><ref refid="classekf_1_1EKF_1aee84ca91742c11dd89683930a58d59e3" kindref="member">dt</ref>)<sp/>+<sp/><ref refid="classekf_1_1EKF_1aae2ea65c4362a5f798db195112fb094a" kindref="member">mF</ref>)<sp/>*<sp/><ref refid="classekf_1_1EKF_1aee84ca91742c11dd89683930a58d59e3" kindref="member">dt</ref>;</highlight></codeline>
<codeline lineno="185"><highlight class="normal">}</highlight></codeline>
<codeline lineno="186"><highlight class="normal"></highlight></codeline>
<codeline lineno="190"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>EKF::integrationOfStates()<sp/>{</highlight></codeline>
<codeline lineno="191"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>Quatérnio<sp/>com<sp/>Euler<sp/>de<sp/>primeira<sp/>ordem</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="192"><highlight class="normal"><sp/><sp/><ref refid="namespaceekf_1a2c0b3448d5cac6f50ad025310b2a9c82" kindref="member">integrationQuaternion</ref>(<ref refid="classekf_1_1EKF_1aa38bc83dfb656519cfcda0c0a589ef16" kindref="member">q</ref>,<sp/><ref refid="classekf_1_1EKF_1af990ea0dbcd3f286f04584ab663d08e6" kindref="member">gyro</ref>,<sp/><ref refid="classekf_1_1EKF_1aee84ca91742c11dd89683930a58d59e3" kindref="member">dt</ref>);</highlight></codeline>
<codeline lineno="193"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>atualiza<sp/>matriz<sp/>de<sp/>rotação<sp/>com<sp/>o<sp/>quaternio<sp/>predito</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="194"><highlight class="normal"><sp/><sp/><ref refid="namespaceekf_1ac031eda654b199bd45807eed2acdb3ec" kindref="member">computeMcdFromQuaternion</ref>(<ref refid="classekf_1_1EKF_1aa38bc83dfb656519cfcda0c0a589ef16" kindref="member">q</ref>,<sp/><ref refid="classekf_1_1EKF_1a2f7f579eb38461f7396cca2a9a846bbb" kindref="member">mcd</ref>);</highlight></codeline>
<codeline lineno="195"><highlight class="normal"><sp/><sp/>Eigen::Vector3f<sp/>_accel_g<sp/>=<sp/><ref refid="classekf_1_1EKF_1aee84ca91742c11dd89683930a58d59e3" kindref="member">dt</ref><sp/>*<sp/>(<ref refid="classekf_1_1EKF_1a2f7f579eb38461f7396cca2a9a846bbb" kindref="member">mcd</ref><sp/>*<sp/><ref refid="classekf_1_1EKF_1a30d3adf68cc6ee599fec8fa45a697bbb" kindref="member">accel</ref><sp/>-<sp/><ref refid="classekf_1_1EKF_1a440b83cfd38de4133d8071a158028c86" kindref="member">navegationGravity</ref>);</highlight></codeline>
<codeline lineno="196"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>integracao<sp/>da<sp/>Posicao<sp/>NED</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="197"><highlight class="normal"><sp/><sp/><ref refid="classekf_1_1EKF_1a833f15f8790f86633d8b02eb2fe3616e" kindref="member">rNED</ref><sp/>+=<sp/>(<ref refid="classekf_1_1EKF_1a93f50b0576c3243487442a9f0934e038" kindref="member">drNED</ref><sp/>+<sp/>0.5f<sp/>*<sp/>_accel_g)<sp/>*<sp/><ref refid="classekf_1_1EKF_1aee84ca91742c11dd89683930a58d59e3" kindref="member">dt</ref>;</highlight></codeline>
<codeline lineno="198"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>integracao<sp/>da<sp/>Velocidade</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="199"><highlight class="normal"><sp/><sp/><ref refid="classekf_1_1EKF_1a93f50b0576c3243487442a9f0934e038" kindref="member">drNED</ref><sp/>+=<sp/>_accel_g;</highlight></codeline>
<codeline lineno="200"><highlight class="normal">}</highlight></codeline>
<codeline lineno="204"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>EKF::updateStage()<sp/>{</highlight></codeline>
<codeline lineno="205"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>Ganho<sp/>de<sp/>Kalman</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="206"><highlight class="normal"><sp/><sp/><ref refid="classekf_1_1EKF_1ae4be03b8440c0f1185141ecc359534df" kindref="member">deltaYObs</ref>.head(4)<sp/>=<sp/><ref refid="classekf_1_1EKF_1a803ccbdd54bfbd96cccf57afa60578a9" kindref="member">qObs</ref><sp/>-<sp/><ref refid="classekf_1_1EKF_1aa38bc83dfb656519cfcda0c0a589ef16" kindref="member">q</ref>;</highlight></codeline>
<codeline lineno="207"><highlight class="normal"><sp/><sp/>updateHq();</highlight></codeline>
<codeline lineno="208"><highlight class="normal"><sp/><sp/><ref refid="classekf_1_1EKF_1a87a29899f611c68db72263cc0be496c7" kindref="member">K</ref>.leftCols(<ref refid="classekf_1_1EKF_1af019016496e0328e5d9ea3cb6462e52c" kindref="member">p</ref>)<sp/>=</highlight></codeline>
<codeline lineno="209"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classekf_1_1EKF_1aec9a3a7de4a079cd1dd1baae26a7a6fc" kindref="member">P</ref><sp/>*<sp/><ref refid="classekf_1_1EKF_1abd11bc2722fab1c582cc91a39372f2ac" kindref="member">H</ref>.topRows(<ref refid="classekf_1_1EKF_1af019016496e0328e5d9ea3cb6462e52c" kindref="member">p</ref>).transpose()<sp/>*</highlight></codeline>
<codeline lineno="210"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>(<ref refid="classekf_1_1EKF_1abd11bc2722fab1c582cc91a39372f2ac" kindref="member">H</ref>.topRows(<ref refid="classekf_1_1EKF_1af019016496e0328e5d9ea3cb6462e52c" kindref="member">p</ref>)<sp/>*<sp/><ref refid="classekf_1_1EKF_1aec9a3a7de4a079cd1dd1baae26a7a6fc" kindref="member">P</ref><sp/>*<sp/><ref refid="classekf_1_1EKF_1abd11bc2722fab1c582cc91a39372f2ac" kindref="member">H</ref>.topRows(<ref refid="classekf_1_1EKF_1af019016496e0328e5d9ea3cb6462e52c" kindref="member">p</ref>).transpose()<sp/>+<sp/><ref refid="classekf_1_1EKF_1ad55e1ba3736ea08721dec76f03dd9715" kindref="member">R</ref>.topLeftCorner(<ref refid="classekf_1_1EKF_1af019016496e0328e5d9ea3cb6462e52c" kindref="member">p</ref>,<sp/><ref refid="classekf_1_1EKF_1af019016496e0328e5d9ea3cb6462e52c" kindref="member">p</ref>))</highlight></codeline>
<codeline lineno="211"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.inverse();</highlight></codeline>
<codeline lineno="212"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>Atualiza<sp/>a<sp/>matriz<sp/>de<sp/>covariância.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="213"><highlight class="normal"><sp/><sp/><ref refid="classekf_1_1EKF_1aec9a3a7de4a079cd1dd1baae26a7a6fc" kindref="member">P</ref><sp/>-=<sp/><ref refid="classekf_1_1EKF_1a87a29899f611c68db72263cc0be496c7" kindref="member">K</ref>.leftCols(<ref refid="classekf_1_1EKF_1af019016496e0328e5d9ea3cb6462e52c" kindref="member">p</ref>)<sp/>*<sp/><ref refid="classekf_1_1EKF_1abd11bc2722fab1c582cc91a39372f2ac" kindref="member">H</ref>.topRows(<ref refid="classekf_1_1EKF_1af019016496e0328e5d9ea3cb6462e52c" kindref="member">p</ref>)<sp/>*<sp/><ref refid="classekf_1_1EKF_1aec9a3a7de4a079cd1dd1baae26a7a6fc" kindref="member">P</ref>;</highlight></codeline>
<codeline lineno="214"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>Computa<sp/>o<sp/>erro<sp/>de<sp/>estimação<sp/>#deltaChi</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="215"><highlight class="normal"><sp/><sp/><ref refid="classekf_1_1EKF_1ad1c353f958f3c41141c88339793745aa" kindref="member">deltaChi</ref>.segment(1,<sp/><ref refid="classekf_1_1EKF_1ae4417522e93314005316a236b324f2a5" kindref="member">n</ref>)<sp/>=<sp/><ref refid="classekf_1_1EKF_1a87a29899f611c68db72263cc0be496c7" kindref="member">K</ref>.leftCols(<ref refid="classekf_1_1EKF_1af019016496e0328e5d9ea3cb6462e52c" kindref="member">p</ref>)<sp/>*<sp/><ref refid="classekf_1_1EKF_1ae4be03b8440c0f1185141ecc359534df" kindref="member">deltaYObs</ref>.head(<ref refid="classekf_1_1EKF_1af019016496e0328e5d9ea3cb6462e52c" kindref="member">p</ref>);</highlight></codeline>
<codeline lineno="216"><highlight class="normal">}</highlight></codeline>
<codeline lineno="222"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>EKF::updateStates()<sp/>{</highlight></codeline>
<codeline lineno="223"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>calcula<sp/>o<sp/>escalar<sp/>do<sp/>erro<sp/>de<sp/>estimação.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="224"><highlight class="normal"><sp/><sp/><ref refid="classekf_1_1EKF_1ad1c353f958f3c41141c88339793745aa" kindref="member">deltaChi</ref>(0)<sp/>=<sp/>sqrtf(1.0f<sp/>-<sp/><ref refid="classekf_1_1EKF_1ad1c353f958f3c41141c88339793745aa" kindref="member">deltaChi</ref>.segment&lt;3&gt;(1).squaredNorm());</highlight></codeline>
<codeline lineno="225"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>Atualiza<sp/>a<sp/>orientação.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="226"><highlight class="normal"><sp/><sp/><ref refid="classekf_1_1EKF_1aa38bc83dfb656519cfcda0c0a589ef16" kindref="member">q</ref><sp/>=<sp/><ref refid="namespaceekf_1a0ae7d9ae45fba00d81bfe71ad73d7fee" kindref="member">multiplyQuaternions</ref>(<ref refid="classekf_1_1EKF_1aa38bc83dfb656519cfcda0c0a589ef16" kindref="member">q</ref>,<sp/><ref refid="classekf_1_1EKF_1ad1c353f958f3c41141c88339793745aa" kindref="member">deltaChi</ref>.head(4));</highlight></codeline>
<codeline lineno="227"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>Atualiza<sp/>o<sp/>bias<sp/>do<sp/>giroscópio.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="228"><highlight class="normal"><sp/><sp/>*<ref refid="classekf_1_1EKF_1a50b05a6fb2c055d9c37e44138a05b08e" kindref="member">biasGyro</ref><sp/>+=<sp/><ref refid="classekf_1_1EKF_1ad1c353f958f3c41141c88339793745aa" kindref="member">deltaChi</ref>.segment&lt;3&gt;(4);</highlight></codeline>
<codeline lineno="230"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>Corrige<sp/>a<sp/>velocidade<sp/>de<sp/>translacao.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="231"><highlight class="normal"><sp/><sp/><ref refid="classekf_1_1EKF_1a93f50b0576c3243487442a9f0934e038" kindref="member">drNED</ref><sp/>+=<sp/><ref refid="classekf_1_1EKF_1ad1c353f958f3c41141c88339793745aa" kindref="member">deltaChi</ref>.segment&lt;3&gt;(7);</highlight></codeline>
<codeline lineno="232"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>Corrige<sp/>o<sp/>bias<sp/>do<sp/>acelerometro.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="233"><highlight class="normal"><sp/><sp/>*<ref refid="classekf_1_1EKF_1a1ac62c76df373623c4cfa0b2b37564db" kindref="member">biasAccel</ref><sp/>+=<sp/><ref refid="classekf_1_1EKF_1ad1c353f958f3c41141c88339793745aa" kindref="member">deltaChi</ref>.segment&lt;3&gt;(10);</highlight></codeline>
<codeline lineno="234"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>Corrige<sp/>a<sp/>posição<sp/>Geodésica</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="235"><highlight class="normal"><sp/><sp/><ref refid="classekf_1_1EKF_1a833f15f8790f86633d8b02eb2fe3616e" kindref="member">rNED</ref><sp/>+=<sp/><ref refid="classekf_1_1EKF_1ad1c353f958f3c41141c88339793745aa" kindref="member">deltaChi</ref>.segment&lt;3&gt;(13);</highlight></codeline>
<codeline lineno="236"><highlight class="normal">}</highlight></codeline>
<codeline lineno="240"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>EKF::updateHq()<sp/>{<sp/><ref refid="classekf_1_1EKF_1abd11bc2722fab1c582cc91a39372f2ac" kindref="member">H</ref>.block&lt;4,<sp/>3&gt;(0,<sp/>0)<sp/>=<sp/><ref refid="namespaceekf_1a34993a331b6837e5274d556e4f0a1bea" kindref="member">Q_l</ref>(<ref refid="classekf_1_1EKF_1aa38bc83dfb656519cfcda0c0a589ef16" kindref="member">q</ref>);<sp/>}</highlight></codeline>
<codeline lineno="244"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>EKF::updateHp()<sp/>{</highlight></codeline>
<codeline lineno="245"><highlight class="normal"><sp/><sp/><ref refid="classekf_1_1EKF_1abd11bc2722fab1c582cc91a39372f2ac" kindref="member">H</ref>.block&lt;3,<sp/>3&gt;(4,<sp/>6)<sp/>=<sp/>Eigen::Matrix3f::Zero();</highlight></codeline>
<codeline lineno="246"><highlight class="normal"><sp/><sp/><ref refid="classekf_1_1EKF_1abd11bc2722fab1c582cc91a39372f2ac" kindref="member">H</ref>.block&lt;3,<sp/>3&gt;(4,<sp/>12)<sp/>=<sp/>Eigen::Matrix3f::Identity();</highlight></codeline>
<codeline lineno="247"><highlight class="normal">}</highlight></codeline>
<codeline lineno="251"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>EKF::updateHv()<sp/>{</highlight></codeline>
<codeline lineno="252"><highlight class="normal"><sp/><sp/><ref refid="classekf_1_1EKF_1abd11bc2722fab1c582cc91a39372f2ac" kindref="member">H</ref>.block&lt;3,<sp/>3&gt;(4,<sp/>6)<sp/>=<sp/>Eigen::Matrix3f::Identity();</highlight></codeline>
<codeline lineno="253"><highlight class="normal"><sp/><sp/><ref refid="classekf_1_1EKF_1abd11bc2722fab1c582cc91a39372f2ac" kindref="member">H</ref>.block&lt;3,<sp/>3&gt;(4,<sp/>12)<sp/>=<sp/>Eigen::Matrix3f::Zero();</highlight></codeline>
<codeline lineno="254"><highlight class="normal">}</highlight></codeline>
<codeline lineno="255"><highlight class="normal"></highlight></codeline>
<codeline lineno="256"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>__XTENSA__</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="261"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>EKF::updateBaseRef()<sp/>{</highlight></codeline>
<codeline lineno="262"><highlight class="normal"><sp/><sp/><ref refid="COMMON_8h_1a6c89b6571752f2a19aff170b1d3d6e58" kindref="member">blindLED</ref>(2);</highlight></codeline>
<codeline lineno="263"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>raio<sp/>Meridional</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="264"><highlight class="normal"><sp/><sp/><ref refid="classekf_1_1EKF_1acd0f4714eb8ba12355d529580e928439" kindref="member">base</ref>.<ref refid="structBASE_1a9a3fd8900988c019d0e2da0491f5600f" kindref="member">RotEcef2ned</ref><sp/>=<sp/>Eigen::Matrix3f::Identity();</highlight></codeline>
<codeline lineno="265"><highlight class="normal"><sp/><sp/><ref refid="classekf_1_1EKF_1acd0f4714eb8ba12355d529580e928439" kindref="member">base</ref>.<ref refid="structBASE_1ae9e7517ae5f24d671f404d18c1d0b90b" kindref="member">rECEF</ref>[0]<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="266"><highlight class="normal"><sp/><sp/><ref refid="classekf_1_1EKF_1acd0f4714eb8ba12355d529580e928439" kindref="member">base</ref>.<ref refid="structBASE_1ae9e7517ae5f24d671f404d18c1d0b90b" kindref="member">rECEF</ref>[1]<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="267"><highlight class="normal"><sp/><sp/><ref refid="classekf_1_1EKF_1acd0f4714eb8ba12355d529580e928439" kindref="member">base</ref>.<ref refid="structBASE_1ae9e7517ae5f24d671f404d18c1d0b90b" kindref="member">rECEF</ref>[2]<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="268"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>_mensagem<sp/>=<sp/><ref refid="GPS_8h_1ad604e63cc857e5663dfba96c37c66bc7" kindref="member">processGPS</ref>();</highlight></codeline>
<codeline lineno="269"><highlight class="normal"><sp/><sp/><ref refid="GPS_8h_1a4ff3f4ce55f117a43c4e117d850ca5a8" kindref="member">ubxMessage</ref>.<ref refid="unionUBXMessage_1aa57d81c1fb373e82012ca3ddadefd79f" kindref="member">navPosecef</ref>.<ref refid="structNAV__POSECEF__STRUCT_1af6632b8d7323f356aac7f34e1656dbba" kindref="member">pAcc</ref><sp/>=<sp/>1000;</highlight></codeline>
<codeline lineno="270"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(<ref refid="GPS_8h_1a4ff3f4ce55f117a43c4e117d850ca5a8" kindref="member">ubxMessage</ref>.<ref refid="unionUBXMessage_1aa57d81c1fb373e82012ca3ddadefd79f" kindref="member">navPosecef</ref>.<ref refid="structNAV__POSECEF__STRUCT_1af6632b8d7323f356aac7f34e1656dbba" kindref="member">pAcc</ref><sp/>&gt;<sp/>300)<sp/>{</highlight></codeline>
<codeline lineno="271"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">true</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="272"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>_mensagem<sp/>=<sp/><ref refid="GPS_8h_1ad604e63cc857e5663dfba96c37c66bc7" kindref="member">processGPS</ref>();</highlight></codeline>
<codeline lineno="273"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(_mensagem<sp/>==<sp/><ref refid="GPS_8h_1a9730e8d0bbbe3f1515ed1d0b2acda1e1ae2379a504fb11d8e00e11bd567a3b819" kindref="member">MT_NAV_POSECEF</ref>)</highlight></codeline>
<codeline lineno="274"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="275"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="276"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>DEBUG_EKF</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="277"><highlight class="normal"><sp/><sp/><sp/><sp/>printf(</highlight><highlight class="stringliteral">&quot;mensagem:<sp/>%d\t%lu\n&quot;</highlight><highlight class="normal">,<sp/>_mensagem,<sp/><ref refid="GPS_8h_1a4ff3f4ce55f117a43c4e117d850ca5a8" kindref="member">ubxMessage</ref>.<ref refid="unionUBXMessage_1aa57d81c1fb373e82012ca3ddadefd79f" kindref="member">navPosecef</ref>.<ref refid="structNAV__POSECEF__STRUCT_1af6632b8d7323f356aac7f34e1656dbba" kindref="member">pAcc</ref>);</highlight></codeline>
<codeline lineno="278"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="279"><highlight class="normal"><sp/><sp/><sp/><sp/>vTaskDelay(100);</highlight></codeline>
<codeline lineno="280"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>mensagem<sp/>em<sp/>cm/s<sp/>e<sp/>em<sp/>long<sp/>para<sp/>subtrair<sp/>na<sp/>transformacao<sp/>ECEF-&gt;NED</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="281"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="classekf_1_1EKF_1acd0f4714eb8ba12355d529580e928439" kindref="member">base</ref>.<ref refid="structBASE_1ae9e7517ae5f24d671f404d18c1d0b90b" kindref="member">rECEF</ref>[0]<sp/>=<sp/><ref refid="GPS_8h_1a4ff3f4ce55f117a43c4e117d850ca5a8" kindref="member">ubxMessage</ref>.<ref refid="unionUBXMessage_1aa57d81c1fb373e82012ca3ddadefd79f" kindref="member">navPosecef</ref>.<ref refid="structNAV__POSECEF__STRUCT_1ad1b8e404ffdeeb1954292e43fe3507b2" kindref="member">ecefX</ref>;</highlight></codeline>
<codeline lineno="282"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="classekf_1_1EKF_1acd0f4714eb8ba12355d529580e928439" kindref="member">base</ref>.<ref refid="structBASE_1ae9e7517ae5f24d671f404d18c1d0b90b" kindref="member">rECEF</ref>[1]<sp/>=<sp/><ref refid="GPS_8h_1a4ff3f4ce55f117a43c4e117d850ca5a8" kindref="member">ubxMessage</ref>.<ref refid="unionUBXMessage_1aa57d81c1fb373e82012ca3ddadefd79f" kindref="member">navPosecef</ref>.<ref refid="structNAV__POSECEF__STRUCT_1a9e56104db13a84e53c2dec44e5ff63b2" kindref="member">ecefY</ref>;</highlight></codeline>
<codeline lineno="283"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="classekf_1_1EKF_1acd0f4714eb8ba12355d529580e928439" kindref="member">base</ref>.<ref refid="structBASE_1ae9e7517ae5f24d671f404d18c1d0b90b" kindref="member">rECEF</ref>[2]<sp/>=<sp/><ref refid="GPS_8h_1a4ff3f4ce55f117a43c4e117d850ca5a8" kindref="member">ubxMessage</ref>.<ref refid="unionUBXMessage_1aa57d81c1fb373e82012ca3ddadefd79f" kindref="member">navPosecef</ref>.<ref refid="structNAV__POSECEF__STRUCT_1acff937b434d1a245763b778f1f15ba66" kindref="member">ecefZ</ref>;</highlight></codeline>
<codeline lineno="284"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="285"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(<ref refid="GPS_8h_1a4ff3f4ce55f117a43c4e117d850ca5a8" kindref="member">ubxMessage</ref>.<ref refid="unionUBXMessage_1ae5d0a8c24ea04c5b48614e3af5dadea4" kindref="member">navPvt</ref>.<ref refid="structNAV__PVT__STRUCT_1af38c07f23fd57d4cb4a88dd99492ce3b" kindref="member">fixType</ref><sp/>!=<sp/>3)<sp/>{</highlight></codeline>
<codeline lineno="286"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">true</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="287"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>_mensagem<sp/>=<sp/><ref refid="GPS_8h_1ad604e63cc857e5663dfba96c37c66bc7" kindref="member">processGPS</ref>();</highlight></codeline>
<codeline lineno="288"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(_mensagem<sp/>==<sp/>2)</highlight></codeline>
<codeline lineno="289"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="290"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="291"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="292"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>DEBUG_EKF</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="293"><highlight class="normal"><sp/><sp/>printf(</highlight><highlight class="stringliteral">&quot;%d\n&quot;</highlight><highlight class="normal">,<sp/><ref refid="GPS_8h_1a4ff3f4ce55f117a43c4e117d850ca5a8" kindref="member">ubxMessage</ref>.<ref refid="unionUBXMessage_1ae5d0a8c24ea04c5b48614e3af5dadea4" kindref="member">navPvt</ref>.<ref refid="structNAV__PVT__STRUCT_1af38c07f23fd57d4cb4a88dd99492ce3b" kindref="member">fixType</ref>);</highlight></codeline>
<codeline lineno="294"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="295"><highlight class="normal"><sp/><sp/><ref refid="classekf_1_1EKF_1acd0f4714eb8ba12355d529580e928439" kindref="member">base</ref>.<ref refid="structBASE_1a76e12d3fb168dc1ce3f163c985382129" kindref="member">lat</ref><sp/>=<sp/>(float)<ref refid="GPS_8h_1a4ff3f4ce55f117a43c4e117d850ca5a8" kindref="member">ubxMessage</ref>.<ref refid="unionUBXMessage_1ae5d0a8c24ea04c5b48614e3af5dadea4" kindref="member">navPvt</ref>.<ref refid="structNAV__PVT__STRUCT_1ab8a62324ff89a0c707884bfc34aba85d" kindref="member">lat</ref><sp/>*<sp/><ref refid="classekf_1_1EKF_1a1aecb83d5af684f4f8637981089002b9" kindref="member">DEG_TO_RAD_BY_10000000</ref>;</highlight></codeline>
<codeline lineno="296"><highlight class="normal"><sp/><sp/><ref refid="classekf_1_1EKF_1acd0f4714eb8ba12355d529580e928439" kindref="member">base</ref>.<ref refid="structBASE_1ac118821d55d84bee606a64e60098c7d4" kindref="member">lon</ref><sp/>=<sp/>(</highlight><highlight class="keywordtype">float</highlight><highlight class="normal">)<ref refid="GPS_8h_1a4ff3f4ce55f117a43c4e117d850ca5a8" kindref="member">ubxMessage</ref>.<ref refid="unionUBXMessage_1ae5d0a8c24ea04c5b48614e3af5dadea4" kindref="member">navPvt</ref>.<ref refid="structNAV__PVT__STRUCT_1ac884e66d0b3ebd6530680ad23e13a81e" kindref="member">lon</ref><sp/>*<sp/><ref refid="classekf_1_1EKF_1a1aecb83d5af684f4f8637981089002b9" kindref="member">DEG_TO_RAD_BY_10000000</ref>;</highlight></codeline>
<codeline lineno="297"><highlight class="normal"><sp/><sp/><ref refid="classekf_1_1EKF_1acd0f4714eb8ba12355d529580e928439" kindref="member">base</ref>.<ref refid="structBASE_1a24573bad2d025ea1b7023eb23b59a46e" kindref="member">hMSL</ref><sp/>=<sp/>(float)<ref refid="GPS_8h_1a4ff3f4ce55f117a43c4e117d850ca5a8" kindref="member">ubxMessage</ref>.<ref refid="unionUBXMessage_1ae5d0a8c24ea04c5b48614e3af5dadea4" kindref="member">navPvt</ref>.<ref refid="structNAV__PVT__STRUCT_1a593d78a85e8db2a7511396023ac72bd6" kindref="member">hMSL</ref><sp/>*<sp/>1e-3;</highlight></codeline>
<codeline lineno="298"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>updade<sp/>Matriz<sp/>ECEF<sp/>-&gt;<sp/>NED</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="299"><highlight class="normal"><sp/><sp/><ref refid="classekf_1_1EKF_1acd0f4714eb8ba12355d529580e928439" kindref="member">base</ref>.<ref refid="structBASE_1a9a3fd8900988c019d0e2da0491f5600f" kindref="member">RotEcef2ned</ref>(0,<sp/>0)<sp/>=<sp/>-sinf(<ref refid="classekf_1_1EKF_1acd0f4714eb8ba12355d529580e928439" kindref="member">base</ref>.<ref refid="structBASE_1a76e12d3fb168dc1ce3f163c985382129" kindref="member">lat</ref>)<sp/>*<sp/>cosf(<ref refid="classekf_1_1EKF_1acd0f4714eb8ba12355d529580e928439" kindref="member">base</ref>.<ref refid="structBASE_1ac118821d55d84bee606a64e60098c7d4" kindref="member">lon</ref>);</highlight></codeline>
<codeline lineno="300"><highlight class="normal"><sp/><sp/><ref refid="classekf_1_1EKF_1acd0f4714eb8ba12355d529580e928439" kindref="member">base</ref>.<ref refid="structBASE_1a9a3fd8900988c019d0e2da0491f5600f" kindref="member">RotEcef2ned</ref>(1,<sp/>0)<sp/>=<sp/>-sinf(<ref refid="classekf_1_1EKF_1acd0f4714eb8ba12355d529580e928439" kindref="member">base</ref>.<ref refid="structBASE_1ac118821d55d84bee606a64e60098c7d4" kindref="member">lon</ref>);</highlight></codeline>
<codeline lineno="301"><highlight class="normal"><sp/><sp/><ref refid="classekf_1_1EKF_1acd0f4714eb8ba12355d529580e928439" kindref="member">base</ref>.<ref refid="structBASE_1a9a3fd8900988c019d0e2da0491f5600f" kindref="member">RotEcef2ned</ref>(2,<sp/>0)<sp/>=<sp/>-cosf(<ref refid="classekf_1_1EKF_1acd0f4714eb8ba12355d529580e928439" kindref="member">base</ref>.<ref refid="structBASE_1a76e12d3fb168dc1ce3f163c985382129" kindref="member">lat</ref>)<sp/>*<sp/>cosf(<ref refid="classekf_1_1EKF_1acd0f4714eb8ba12355d529580e928439" kindref="member">base</ref>.<ref refid="structBASE_1ac118821d55d84bee606a64e60098c7d4" kindref="member">lon</ref>);</highlight></codeline>
<codeline lineno="302"><highlight class="normal"><sp/><sp/><ref refid="classekf_1_1EKF_1acd0f4714eb8ba12355d529580e928439" kindref="member">base</ref>.<ref refid="structBASE_1a9a3fd8900988c019d0e2da0491f5600f" kindref="member">RotEcef2ned</ref>(0,<sp/>1)<sp/>=<sp/>-sinf(<ref refid="classekf_1_1EKF_1acd0f4714eb8ba12355d529580e928439" kindref="member">base</ref>.<ref refid="structBASE_1a76e12d3fb168dc1ce3f163c985382129" kindref="member">lat</ref>)<sp/>*<sp/>sinf(<ref refid="classekf_1_1EKF_1acd0f4714eb8ba12355d529580e928439" kindref="member">base</ref>.<ref refid="structBASE_1ac118821d55d84bee606a64e60098c7d4" kindref="member">lon</ref>);</highlight></codeline>
<codeline lineno="303"><highlight class="normal"><sp/><sp/><ref refid="classekf_1_1EKF_1acd0f4714eb8ba12355d529580e928439" kindref="member">base</ref>.<ref refid="structBASE_1a9a3fd8900988c019d0e2da0491f5600f" kindref="member">RotEcef2ned</ref>(1,<sp/>1)<sp/>=<sp/>cosf(<ref refid="classekf_1_1EKF_1acd0f4714eb8ba12355d529580e928439" kindref="member">base</ref>.<ref refid="structBASE_1ac118821d55d84bee606a64e60098c7d4" kindref="member">lon</ref>);</highlight></codeline>
<codeline lineno="304"><highlight class="normal"><sp/><sp/><ref refid="classekf_1_1EKF_1acd0f4714eb8ba12355d529580e928439" kindref="member">base</ref>.<ref refid="structBASE_1a9a3fd8900988c019d0e2da0491f5600f" kindref="member">RotEcef2ned</ref>(2,<sp/>1)<sp/>=<sp/>-cosf(<ref refid="classekf_1_1EKF_1acd0f4714eb8ba12355d529580e928439" kindref="member">base</ref>.<ref refid="structBASE_1a76e12d3fb168dc1ce3f163c985382129" kindref="member">lat</ref>)<sp/>*<sp/>sinf(<ref refid="classekf_1_1EKF_1acd0f4714eb8ba12355d529580e928439" kindref="member">base</ref>.<ref refid="structBASE_1ac118821d55d84bee606a64e60098c7d4" kindref="member">lon</ref>);</highlight></codeline>
<codeline lineno="305"><highlight class="normal"><sp/><sp/><ref refid="classekf_1_1EKF_1acd0f4714eb8ba12355d529580e928439" kindref="member">base</ref>.<ref refid="structBASE_1a9a3fd8900988c019d0e2da0491f5600f" kindref="member">RotEcef2ned</ref>(0,<sp/>2)<sp/>=<sp/>cosf(<ref refid="classekf_1_1EKF_1acd0f4714eb8ba12355d529580e928439" kindref="member">base</ref>.<ref refid="structBASE_1a76e12d3fb168dc1ce3f163c985382129" kindref="member">lat</ref>);</highlight></codeline>
<codeline lineno="306"><highlight class="normal"><sp/><sp/><ref refid="classekf_1_1EKF_1acd0f4714eb8ba12355d529580e928439" kindref="member">base</ref>.<ref refid="structBASE_1a9a3fd8900988c019d0e2da0491f5600f" kindref="member">RotEcef2ned</ref>(1,<sp/>2)<sp/>=<sp/>0.0f;</highlight></codeline>
<codeline lineno="307"><highlight class="normal"><sp/><sp/><ref refid="classekf_1_1EKF_1acd0f4714eb8ba12355d529580e928439" kindref="member">base</ref>.<ref refid="structBASE_1a9a3fd8900988c019d0e2da0491f5600f" kindref="member">RotEcef2ned</ref>(2,<sp/>2)<sp/>=<sp/>-sinf(<ref refid="classekf_1_1EKF_1acd0f4714eb8ba12355d529580e928439" kindref="member">base</ref>.<ref refid="structBASE_1a76e12d3fb168dc1ce3f163c985382129" kindref="member">lat</ref>);</highlight></codeline>
<codeline lineno="308"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(<ref refid="GPS_8h_1ad604e63cc857e5663dfba96c37c66bc7" kindref="member">processGPS</ref>()<sp/>!=<sp/><ref refid="GPS_8h_1a9730e8d0bbbe3f1515ed1d0b2acda1e1ae2379a504fb11d8e00e11bd567a3b819" kindref="member">MT_NAV_POSECEF</ref>)<sp/>{</highlight></codeline>
<codeline lineno="309"><highlight class="normal"><sp/><sp/><sp/><sp/>vTaskDelay(1000);</highlight></codeline>
<codeline lineno="310"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="311"><highlight class="normal"><sp/><sp/>updateNedPos();</highlight></codeline>
<codeline lineno="312"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>DEBUG_EKF</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="313"><highlight class="normal"><sp/><sp/>printf(</highlight><highlight class="stringliteral">&quot;lon:<sp/>%f\tlat:<sp/>%f\thMSL:<sp/>%f\t\n&quot;</highlight><highlight class="normal">,<sp/><ref refid="classekf_1_1EKF_1acd0f4714eb8ba12355d529580e928439" kindref="member">base</ref>.<ref refid="structBASE_1ac118821d55d84bee606a64e60098c7d4" kindref="member">lon</ref>,<sp/><ref refid="classekf_1_1EKF_1acd0f4714eb8ba12355d529580e928439" kindref="member">base</ref>.<ref refid="structBASE_1a76e12d3fb168dc1ce3f163c985382129" kindref="member">lat</ref>,<sp/><ref refid="classekf_1_1EKF_1acd0f4714eb8ba12355d529580e928439" kindref="member">base</ref>.<ref refid="structBASE_1a24573bad2d025ea1b7023eb23b59a46e" kindref="member">hMSL</ref>);</highlight></codeline>
<codeline lineno="314"><highlight class="normal"><sp/><sp/>printf(</highlight><highlight class="stringliteral">&quot;%s\n&quot;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&quot;Matrix<sp/>de<sp/>transformacao<sp/>ECEF<sp/>to<sp/>NED&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="315"><highlight class="normal"><sp/><sp/><ref refid="namespaceekf_1ae9e1aaaa7793db099f4ef88b44aab8d5" kindref="member">printEigen</ref>(<ref refid="classekf_1_1EKF_1acd0f4714eb8ba12355d529580e928439" kindref="member">base</ref>.<ref refid="structBASE_1a9a3fd8900988c019d0e2da0491f5600f" kindref="member">RotEcef2ned</ref>);</highlight></codeline>
<codeline lineno="316"><highlight class="normal"><sp/><sp/>printf(</highlight><highlight class="stringliteral">&quot;%s\n&quot;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&quot;Coordenadas<sp/>ECEF&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="317"><highlight class="normal"><sp/><sp/>printf(</highlight><highlight class="stringliteral">&quot;%ld\t,%ld\t,%ld\t\n&quot;</highlight><highlight class="normal">,<sp/><ref refid="classekf_1_1EKF_1acd0f4714eb8ba12355d529580e928439" kindref="member">base</ref>.<ref refid="structBASE_1ae9e7517ae5f24d671f404d18c1d0b90b" kindref="member">rECEF</ref>[0]<sp/>/<sp/>100,<sp/><ref refid="classekf_1_1EKF_1acd0f4714eb8ba12355d529580e928439" kindref="member">base</ref>.<ref refid="structBASE_1ae9e7517ae5f24d671f404d18c1d0b90b" kindref="member">rECEF</ref>[1]<sp/>/<sp/>100,</highlight></codeline>
<codeline lineno="318"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classekf_1_1EKF_1acd0f4714eb8ba12355d529580e928439" kindref="member">base</ref>.<ref refid="structBASE_1ae9e7517ae5f24d671f404d18c1d0b90b" kindref="member">rECEF</ref>[2]<sp/>/<sp/>100);</highlight></codeline>
<codeline lineno="319"><highlight class="normal"><sp/><sp/>printf(</highlight><highlight class="stringliteral">&quot;%s\n&quot;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&quot;Coordenadas<sp/>NED<sp/>em<sp/>m&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="320"><highlight class="normal"><sp/><sp/><ref refid="namespaceekf_1ae9e1aaaa7793db099f4ef88b44aab8d5" kindref="member">printEigen</ref>(<ref refid="classekf_1_1EKF_1a649f7d975dc55413be50d8f1e6bc2559" kindref="member">rNEDgps</ref>);</highlight></codeline>
<codeline lineno="321"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="322"><highlight class="normal"><sp/><sp/><ref refid="COMMON_8h_1a6c89b6571752f2a19aff170b1d3d6e58" kindref="member">blindLED</ref>(5);</highlight></codeline>
<codeline lineno="323"><highlight class="normal"><sp/><sp/><ref refid="COMMON_8h_1a8eabef94a982b1407d1ae4731b7e07ca" kindref="member">turnOnLed</ref>();</highlight></codeline>
<codeline lineno="324"><highlight class="normal">}</highlight></codeline>
<codeline lineno="325"><highlight class="normal"></highlight></codeline>
<codeline lineno="330"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>EKF::updateNedPos()<sp/>{</highlight></codeline>
<codeline lineno="331"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>NOTE:<sp/>a<sp/>mensagem<sp/>ubxMessage.navPosecef<sp/>fornece<sp/>as<sp/>medidas<sp/>em<sp/>cm.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="332"><highlight class="normal"><sp/><sp/><ref refid="classekf_1_1EKF_1a649f7d975dc55413be50d8f1e6bc2559" kindref="member">rNEDgps</ref><sp/>=<sp/><ref refid="classekf_1_1EKF_1acd0f4714eb8ba12355d529580e928439" kindref="member">base</ref>.<ref refid="structBASE_1a9a3fd8900988c019d0e2da0491f5600f" kindref="member">RotEcef2ned</ref>.col(0)<sp/>*</highlight></codeline>
<codeline lineno="333"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(0.01<sp/>*<sp/>(float)(<ref refid="GPS_8h_1a4ff3f4ce55f117a43c4e117d850ca5a8" kindref="member">ubxMessage</ref>.<ref refid="unionUBXMessage_1aa57d81c1fb373e82012ca3ddadefd79f" kindref="member">navPosecef</ref>.<ref refid="structNAV__POSECEF__STRUCT_1ad1b8e404ffdeeb1954292e43fe3507b2" kindref="member">ecefX</ref><sp/>-<sp/><ref refid="classekf_1_1EKF_1acd0f4714eb8ba12355d529580e928439" kindref="member">base</ref>.<ref refid="structBASE_1ae9e7517ae5f24d671f404d18c1d0b90b" kindref="member">rECEF</ref>[0]))<sp/>+</highlight></codeline>
<codeline lineno="334"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classekf_1_1EKF_1acd0f4714eb8ba12355d529580e928439" kindref="member">base</ref>.<ref refid="structBASE_1a9a3fd8900988c019d0e2da0491f5600f" kindref="member">RotEcef2ned</ref>.col(1)<sp/>*</highlight></codeline>
<codeline lineno="335"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(0.01<sp/>*<sp/>(float)(<ref refid="GPS_8h_1a4ff3f4ce55f117a43c4e117d850ca5a8" kindref="member">ubxMessage</ref>.<ref refid="unionUBXMessage_1aa57d81c1fb373e82012ca3ddadefd79f" kindref="member">navPosecef</ref>.<ref refid="structNAV__POSECEF__STRUCT_1a9e56104db13a84e53c2dec44e5ff63b2" kindref="member">ecefY</ref><sp/>-<sp/><ref refid="classekf_1_1EKF_1acd0f4714eb8ba12355d529580e928439" kindref="member">base</ref>.<ref refid="structBASE_1ae9e7517ae5f24d671f404d18c1d0b90b" kindref="member">rECEF</ref>[1]))<sp/>+</highlight></codeline>
<codeline lineno="336"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classekf_1_1EKF_1acd0f4714eb8ba12355d529580e928439" kindref="member">base</ref>.<ref refid="structBASE_1a9a3fd8900988c019d0e2da0491f5600f" kindref="member">RotEcef2ned</ref>.col(2)<sp/>*</highlight></codeline>
<codeline lineno="337"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(0.01<sp/>*<sp/>(float)(<ref refid="GPS_8h_1a4ff3f4ce55f117a43c4e117d850ca5a8" kindref="member">ubxMessage</ref>.<ref refid="unionUBXMessage_1aa57d81c1fb373e82012ca3ddadefd79f" kindref="member">navPosecef</ref>.<ref refid="structNAV__POSECEF__STRUCT_1acff937b434d1a245763b778f1f15ba66" kindref="member">ecefZ</ref><sp/>-<sp/><ref refid="classekf_1_1EKF_1acd0f4714eb8ba12355d529580e928439" kindref="member">base</ref>.<ref refid="structBASE_1ae9e7517ae5f24d671f404d18c1d0b90b" kindref="member">rECEF</ref>[2]));</highlight></codeline>
<codeline lineno="338"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>atualiza<sp/>a<sp/>matriz<sp/>H<sp/>correspondente<sp/>á<sp/>posição.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="339"><highlight class="normal"><sp/><sp/>updateHp();</highlight></codeline>
<codeline lineno="340"><highlight class="normal">}</highlight></codeline>
<codeline lineno="344"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>EKF::updateNedVel()<sp/>{</highlight></codeline>
<codeline lineno="345"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>NOTE:<sp/>(float)ubxMessage.navPvt.velX<sp/>está<sp/>em<sp/>mm/s.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="346"><highlight class="normal"><sp/><sp/><ref refid="classekf_1_1EKF_1ad27f8aac391293234c9e21c02b944cc4" kindref="member">drNEDgps</ref>(0)<sp/>=<sp/>0.001f<sp/>*<sp/>(float)<ref refid="GPS_8h_1a4ff3f4ce55f117a43c4e117d850ca5a8" kindref="member">ubxMessage</ref>.<ref refid="unionUBXMessage_1ae5d0a8c24ea04c5b48614e3af5dadea4" kindref="member">navPvt</ref>.<ref refid="structNAV__PVT__STRUCT_1a9f0c42e0df789f5ed086349ad79d1f9c" kindref="member">velN</ref>;</highlight></codeline>
<codeline lineno="347"><highlight class="normal"><sp/><sp/><ref refid="classekf_1_1EKF_1ad27f8aac391293234c9e21c02b944cc4" kindref="member">drNEDgps</ref>(1)<sp/>=<sp/>0.001f<sp/>*<sp/>(float)<ref refid="GPS_8h_1a4ff3f4ce55f117a43c4e117d850ca5a8" kindref="member">ubxMessage</ref>.<ref refid="unionUBXMessage_1ae5d0a8c24ea04c5b48614e3af5dadea4" kindref="member">navPvt</ref>.<ref refid="structNAV__PVT__STRUCT_1a1abd8ac18139ec0e1148cbea6cd36b18" kindref="member">velE</ref>;</highlight></codeline>
<codeline lineno="348"><highlight class="normal"><sp/><sp/><ref refid="classekf_1_1EKF_1ad27f8aac391293234c9e21c02b944cc4" kindref="member">drNEDgps</ref>(2)<sp/>=<sp/>0.001f<sp/>*<sp/>(float)<ref refid="GPS_8h_1a4ff3f4ce55f117a43c4e117d850ca5a8" kindref="member">ubxMessage</ref>.<ref refid="unionUBXMessage_1ae5d0a8c24ea04c5b48614e3af5dadea4" kindref="member">navPvt</ref>.<ref refid="structNAV__PVT__STRUCT_1ae5860d883e58fa8d23dba2c4aa1c3e45" kindref="member">velD</ref>;</highlight></codeline>
<codeline lineno="349"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>atualiza<sp/>a<sp/>matriz<sp/>H<sp/>correspondente<sp/>á<sp/>velocidade</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="350"><highlight class="normal"><sp/><sp/>updateHv();</highlight></codeline>
<codeline lineno="351"><highlight class="normal">}</highlight></codeline>
<codeline lineno="352"><highlight class="normal"></highlight></codeline>
<codeline lineno="357"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>EKF::calibrationMethods()<sp/>{</highlight></codeline>
<codeline lineno="358"><highlight class="normal"><sp/><sp/><ref refid="COMMON_8h_1a6c89b6571752f2a19aff170b1d3d6e58" kindref="member">blindLED</ref>(3);</highlight></codeline>
<codeline lineno="359"><highlight class="normal"><sp/><sp/>imu.<ref refid="classIMU_1a5f096cb37d4b16851381bf09d6809403" kindref="member">calibraGyro</ref>(200);</highlight></codeline>
<codeline lineno="360"><highlight class="normal"><sp/><sp/><ref refid="COMMON_8h_1a6c89b6571752f2a19aff170b1d3d6e58" kindref="member">blindLED</ref>(5);</highlight></codeline>
<codeline lineno="361"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(imu.<ref refid="classIMU_1a3546779010d9128859f465195eff77f5" kindref="member">calibracaoMagnetometro</ref>(22.8908f)<sp/>&lt;<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="362"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="COMMON_8h_1a6c89b6571752f2a19aff170b1d3d6e58" kindref="member">blindLED</ref>(2);</highlight></codeline>
<codeline lineno="363"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="364"><highlight class="normal"><sp/><sp/>timeClass.<ref refid="classTIME_1a51b6020daf09773ef3948cf6b9ccd736" kindref="member">computeElapsedTime</ref>();</highlight></codeline>
<codeline lineno="365"><highlight class="normal"><sp/><sp/>timeClass.<ref refid="classTIME_1a51b6020daf09773ef3948cf6b9ccd736" kindref="member">computeElapsedTime</ref>();</highlight></codeline>
<codeline lineno="366"><highlight class="normal"><sp/><sp/><ref refid="COMMON_8h_1a6c89b6571752f2a19aff170b1d3d6e58" kindref="member">blindLED</ref>(3);</highlight></codeline>
<codeline lineno="367"><highlight class="normal">}</highlight></codeline>
<codeline lineno="368"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="369"><highlight class="normal"></highlight></codeline>
<codeline lineno="370"><highlight class="normal">}<sp/></highlight><highlight class="comment">//<sp/>namespace<sp/>ekf</highlight></codeline>
    </programlisting>
    <location file="lib/EKF/EKF.cpp"/>
  </compounddef>
</doxygen>
